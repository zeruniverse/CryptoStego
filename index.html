<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>CryptoStego DEMO</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>CryptoStego</h1>
        <h2>JS library for steganography with encryption - Hide text in an image with encryption and obfuscation.</h2>
        <a href="https://github.com/zeruniverse/CryptoStego" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h3>
            <a id="how-to-use" class="anchor" href="#how-to-use" aria-hidden="true">
              <span aria-hidden="true" class="octicon octicon-link"></span>
            </a>Introduction</h3>

          <p>This JS library provides functions to load an image from a file input into a canvas, write a message to the image in the canvas, and read a message from the image in the canvas.</p>
          <p>Below is a simple example showing how the library works!</p>

          <h3>
            <a id="example" class="anchor" href="#example" aria-hidden="true">
              <span aria-hidden="true" class="octicon octicon-link"></span>
            </a>Example</h3>

            <!-- Step 0: Model Selector -->
          <h4 style="color:blue">Step 0. Select which model to use</h4>

          <p>
            <label>
              <input type="radio" name="modelType" value="0" checked>
              Use model optimized for visual similarity
            </label>
          </p>
          <p>
            <label>
              <input type="radio" name="modelType" value="1">
              Use model optimized for robustness
            </label>
          </p>

          <h4 style="color:blue">Step 1. Select an image from your computer (Don't use images smaller than 512 x 512)</h4>
          <p><input type="file" id="file" accept="image/*" /></p>

          <h4 style="color:blue">Step 2. Optionally set/input a password for retrieving the message</h4>
          <p>Password: <input type="text" id="pass" value="" placeholder="No Password"/></p>

          <h4 style="color:blue">Results</h4>
          <p>
            <div id="result" style="background-color: rgba(0,255,0,0.3); padding: 10px;">Please complete Steps 0, 1, and 2 above and click a button below. Your result will then show up here!</div>
          </p>
          <p>
            <img id="resultimg" style="display:none; max-width: 100%; height: auto;" src="" />
          </p>

          <h4 style="color:blue">What do you want to do?</h4>
          <p>
            <textarea id="msg" style="width:100%;height:50px;">This Awesome Message Will be Written into the Image!</textarea>
          </p>
          <a href="javascript: showLoading()" id="encodeButton" class="button">Write Message into Image</a>
          <p>OR:</p>
          <a href="javascript: showLoading()" id="decodeButton" class="button" style="background-image: url(images/main-bar1.png);"><span style="color:black">Read Message from Image</span></a>

          <h3>
            <a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true">
              <span aria-hidden="true" class="octicon octicon-link"></span>
            </a>Support</h3>

          <p>Having trouble with this library or demo? <a href="https://github.com/zeruniverse/CryptoStego/issues/new">Submit an issue</a> and weâ€™ll help you sort it out.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/zeruniverse/CryptoStego/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/zeruniverse/CryptoStego/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/zeruniverse/CryptoStego"></a> is maintained by <a href="https://github.com/zeruniverse">zeruniverse</a>.</p>

          <p>GitHub Pages using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

    <!-- Hidden canvas element for processing -->
    <canvas id="canvas" style="display:none;"></canvas>

    <!-- Include jQuery (still used by the demo page) -->
    <script type="text/javascript" src="jquery.min.js"></script>

    <!-- Include stego.js as an ES6 module -->
    <script type="module">
      import { initCodecs, isCodecsReady, loadIMGtoCanvas, writeMsgToCanvas, readMsgFromCanvas } from './stego.js';

      // Initialize Codec Sessions
      initCodecs().then(() => {
          // Enable buttons after successful initialization
          document.getElementById('encodeButton').href = "javascript: writeIMG()";
          document.getElementById('decodeButton').href = "javascript: readIMG()";
          console.log('Codec sessions initialized successfully.');
      }).catch((error) => {
          // Display error message
          document.getElementById('result').innerHTML = `Error initializing codecs: ${error.message}`;
          console.error('Codec initialization error:', error);
      });

      /**
       * Function to get the selected model type.
       * Returns 0 for visual similarity and 1 for robustness.
       */
      function getModelType() {
          const selected = document.querySelector('input[name="modelType"]:checked');
          return selected ? parseInt(selected.value, 10) : 0;
      }

      /**
       * Function to handle writing a message into an image.
       */
      window.writeIMG = async function() {
          $("#resultimg").hide();
          $("#resultimg").attr('src','');
          $("#result").html('Processing...');

          try {
              // Get user inputs
              const password = $("#pass").val() || '';
              const message = $("#msg").val();
              const modelType = getModelType(); // Get the selected model type

              // Load the selected image into the canvas
              await loadIMGtoCanvas('file', 'canvas', 1920);

              // Write the message into the canvas image with the selected model type
              const isOK = await writeMsgToCanvas('canvas', message, password, modelType);

              // Retrieve the encoded image from the canvas
              const myCanvas = document.getElementById("canvas");
              const image = myCanvas.toDataURL("image/png");

              // Display the encoded image
              $("#resultimg").attr('src', image);
              if(isOK){
                $("#result").html('Success! Save the result image below and share it with others.');
              } else {
                $("#result").html('The encoded image is generated. But it cannot be decoded.<br />Try to use a different image (better to be larger than 512*512)');
              }

              $("#resultimg").show();
          } catch (error) {
              // Display error message
              $("#result").html(`Error: ${error.message}`);
              console.error('Write Message Error:', error);
          }
      }

      /**
       * Function to handle reading a message from an image.
       */
      window.readIMG = async function() {
          $("#resultimg").hide();
          $("#result").html('Processing...');

          try {
              // Get user inputs
              const password = $("#pass").val() || '';
              const modelType = getModelType(); // Get the selected model type

              // Load the selected image into the canvas
              await loadIMGtoCanvas('file', 'canvas', 1920);

              // Read the message from the canvas image with the selected model type
              const message = await readMsgFromCanvas('canvas', password, modelType);

              // Format the message for display
              const formattedMessage = message
                  .replace(/&/g, '&amp;')
                  .replace(/ /g, '&nbsp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/(?:\r\n|\r|\n)/g, '<br />');

              // Display the decoded message
              $("#result").html(formattedMessage);
          } catch (error) {
              // Display error message
              $("#result").html('ERROR REVEALING MESSAGE!');
              console.error('Read Message Error:', error);
          }
      }

      window.showLoading = function() {
        $("#result").html("DEMO is initializing, please wait...<br />If this lasts for a long time, open console to check errors.");
      }
    </script>
  </body>
</html>
